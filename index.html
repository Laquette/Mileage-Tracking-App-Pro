<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>TrackDrive Pro</title>
    
    <!-- Leaflet CSS pour la carte -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Vue principale avec carte */
        .map-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f0f0f0;
        }

        .map-view.active {
            display: block;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Header pendant le trajet */
        .tracking-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px;
            padding-top: calc(15px + env(safe-area-inset-top));
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tracking-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 24px;
        }

        .tracking-title {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: #000;
        }

        /* Stats en temps réel */
        .tracking-stats {
            position: absolute;
            top: calc(80px + env(safe-area-inset-top));
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            z-index: 1000;
            min-width: 120px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-bottom: 3px;
        }

        .stat-value {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .stat-value:last-child {
            margin-bottom: 0;
        }

        .stat-unit {
            font-size: 14px;
            font-weight: 400;
            margin-left: 2px;
        }

        /* Panneau d'informations du bas */
        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            max-height: 60vh;
            overflow-y: auto;
        }

        .location-info {
            margin-bottom: 20px;
        }

        .location-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .location-item:last-child {
            border-bottom: none;
        }

        .location-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .location-marker.start {
            background: #e8e8e8;
            color: #333;
        }

        .location-marker.end {
            background: #e8e8e8;
            color: #666;
        }

        .location-details {
            flex: 1;
        }

        .location-name {
            font-size: 16px;
            font-weight: 600;
            color: #000;
            margin-bottom: 4px;
        }

        .location-address {
            font-size: 14px;
            color: #666;
            line-height: 1.3;
        }

        .location-time {
            margin-left: auto;
            text-align: right;
            min-width: 60px;
        }

        .time-label {
            font-size: 12px;
            color: #999;
            display: block;
            margin-bottom: 2px;
        }

        .time-value {
            font-size: 16px;
            color: #000;
            font-weight: 500;
        }

        /* Boutons de catégorie */
        .category-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .category-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 15px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .category-btn.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        /* Champs d'entrée */
        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            font-size: 16px;
            margin-bottom: 15px;
            background: transparent;
            color: #333;
        }

        .input-field:focus {
            outline: none;
            border-bottom-color: #007AFF;
        }

        .input-field::placeholder {
            color: #999;
        }

        .note-field {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            font-size: 16px;
            margin-bottom: 20px;
            background: transparent;
            color: #333;
            min-height: 60px;
            resize: none;
            font-family: inherit;
        }

        .note-field:focus {
            outline: none;
            border-bottom-color: #007AFF;
        }

        /* Bouton Arrêter */
        .stop-button {
            width: 100%;
            padding: 17px;
            background: white;
            border: 2px solid #FF3B30;
            border-radius: 12px;
            color: #FF3B30;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stop-button:active {
            transform: scale(0.98);
            background: #ffebea;
        }

        /* Vue normale (sélection initiale) */
        .normal-view {
            display: block;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .normal-view.hidden {
            display: none;
        }

        .app-header {
            text-align: center;
            color: white;
            padding: 40px 0;
        }

        .app-header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .app-header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .selection-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .vehicle-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .vehicle-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .quick-start-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .quick-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .quick-start-btn:active {
            transform: scale(0.98);
        }

        .menu-btn {
            width: 100%;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-btn:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .menu-icon {
            font-size: 20px;
        }

        /* Historique compact */
        .recent-trips {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .recent-trips h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .trip-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-info {
            flex: 1;
        }

        .trip-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 2px;
        }

        .trip-desc {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .trip-distance {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }

        /* Modal pour détails/édition */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        /* Responsive iOS */
        @supports (-webkit-touch-callout: none) {
            .bottom-panel {
                padding-bottom: calc(30px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <!-- Vue carte (pendant le trajet) -->
    <div id="mapView" class="map-view">
        <div id="map"></div>
        
        <div class="tracking-header">
            <div class="tracking-icon">📍</div>
            <div class="tracking-title">Enregistrement d'un trajet...</div>
        </div>

        <div class="tracking-stats">
            <div class="stat-label">Distance</div>
            <div class="stat-value"><span id="liveDistance">0</span><span class="stat-unit">km</span></div>
            <div class="stat-label">Montant</div>
            <div class="stat-value">$<span id="liveAmount">0</span></div>
        </div>

        <div class="bottom-panel">
            <div class="location-info">
                <div class="location-item">
                    <div class="location-marker start">A</div>
                    <div class="location-details">
                        <div class="location-name" id="startLocationName">Maison</div>
                        <div class="location-address" id="startLocationAddress">Recherche de l'adresse...</div>
                    </div>
                    <div class="location-time">
                        <span class="time-label" id="startDate">-</span>
                        <span class="time-value" id="startTime">-</span>
                    </div>
                </div>
                
                <div class="location-item">
                    <div class="location-marker end">B</div>
                    <div class="location-details">
                        <div class="location-name">Destination</div>
                        <div class="location-address" id="currentLocationAddress">Nous ajouterons l'emplacement une fois trajet terminé</div>
                    </div>
                </div>
            </div>

            <div class="category-buttons">
                <button class="category-btn" id="btnPersonal" onclick="setCategory('personal')">
                    🏠 Personnel
                </button>
                <button class="category-btn active" id="btnProfessional" onclick="setCategory('professional')">
                    💼 Professionnel
                </button>
            </div>

            <input type="text" class="input-field" id="trackingTags" placeholder="Ajouter des étiquettes">
            
            <textarea class="note-field" id="trackingNote" placeholder="Écrire une note"></textarea>

            <button class="stop-button" onclick="stopTracking()">Arrêter</button>
        </div>
    </div>

    <!-- Vue normale (sélection initiale) -->
    <div id="normalView" class="normal-view">
        <div class="app-header">
            <h1>🚗 TrackDrive Pro</h1>
            <p>Gestionnaire de déplacements professionnels</p>
        </div>

        <div class="selection-card">
            <select id="vehicleSelect" class="vehicle-select">
                <option value="">Sélectionner un véhicule</option>
            </select>

            <button class="quick-start-btn" onclick="quickStart()">
                📍 Démarrage rapide
            </button>

            <button class="menu-btn" onclick="showVehicles()">
                <span class="menu-icon">🚙</span>
                <span>Gérer les véhicules</span>
            </button>

            <button class="menu-btn" onclick="showHistory()">
                <span class="menu-icon">📊</span>
                <span>Historique complet</span>
            </button>

            <button class="menu-btn" onclick="showSettings()">
                <span class="menu-icon">⚙️</span>
                <span>Paramètres</span>
            </button>

            <div class="recent-trips">
                <h3>Trajets récents</h3>
                <div id="recentTripsList"></div>
            </div>
        </div>
    </div>

    <!-- Modal pour l'édition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Modifier le trajet</div>
            <div id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveModal()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS pour la carte -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // État de l'application
        let appState = {
            isTracking: false,
            currentTrip: null,
            vehicles: [],
            trips: [],
            settings: {
                ratePerKm: 0.70,
                defaultVehicle: null,
                companyName: ''
            },
            watchId: null,
            map: null,
            markers: {
                start: null,
                current: null,
                path: null
            },
            category: 'professional',
            modalAction: null,
            editingTripId: null
        };

        // Initialisation
        function init() {
            loadData();
            updateVehicleSelect();
            updateRecentTrips();
            
            // Charger le véhicule par défaut
            if (appState.settings.defaultVehicle) {
                document.getElementById('vehicleSelect').value = appState.settings.defaultVehicle;
            }
        }

        // Initialiser la carte
        function initMap(lat = 45.5017, lng = -73.5673) {
            if (!appState.map) {
                appState.map = L.map('map').setView([lat, lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap',
                    maxZoom: 19
                }).addTo(appState.map);
            } else {
                appState.map.setView([lat, lng], 15);
            }
        }

        // Chargement des données
        function loadData() {
            try {
                const savedData = localStorage.getItem('trackDriveData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    appState.vehicles = data.vehicles || [];
                    appState.trips = data.trips || [];
                    appState.settings = data.settings || appState.settings;
                }
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
            }
        }

        // Sauvegarde des données
        function saveData() {
            try {
                const dataToSave = {
                    vehicles: appState.vehicles,
                    trips: appState.trips,
                    settings: appState.settings
                };
                localStorage.setItem('trackDriveData', JSON.stringify(dataToSave));
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
            }
        }

        // Démarrage rapide (sans description obligatoire)
        function quickStart() {
            const selectedVehicle = document.getElementById('vehicleSelect').value;
            
            if (!selectedVehicle) {
                alert('Veuillez sélectionner un véhicule avant de démarrer.');
                return;
            }

            // Basculer vers la vue carte
            document.getElementById('normalView').classList.add('hidden');
            document.getElementById('mapView').classList.add('active');

            // Réinitialiser les champs
            document.getElementById('trackingNote').value = '';
            document.getElementById('trackingTags').value = '';

            // Initialiser la carte
            setTimeout(() => {
                initMap();
                startTracking();
            }, 100);
        }

        // Définir la catégorie
        function setCategory(category) {
            appState.category = category;
            document.getElementById('btnPersonal').classList.toggle('active', category === 'personal');
            document.getElementById('btnProfessional').classList.toggle('active', category === 'professional');
        }

        // Démarrer le suivi GPS
        function startTracking() {
            if (!navigator.geolocation) {
                alert('La géolocalisation n\'est pas supportée par votre navigateur.');
                return;
            }

            appState.isTracking = true;

            // Afficher la date et l'heure de départ
            const now = new Date();
            const months = ['janv', 'févr', 'mars', 'avr', 'mai', 'juin', 'juil', 'août', 'sept', 'oct', 'nov', 'déc'];
            const dateStr = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            document.getElementById('startDate').textContent = dateStr;
            document.getElementById('startTime').textContent = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            appState.currentTrip = {
                vehicleId: document.getElementById('vehicleSelect').value,
                reason: '', // Sera ajouté plus tard
                category: appState.category,
                tags: '',
                note: '',
                startTime: now,
                startLocation: null,
                startAddress: 'Recherche de l\'adresse...',
                endLocation: null,
                endAddress: '',
                positions: [],
                distance: 0,
                polyline: []
            };

            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };

            // Position initiale
            navigator.geolocation.getCurrentPosition(
                async position => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        timestamp: position.timestamp
                    };
                    
                    appState.currentTrip.startLocation = coords;
                    appState.currentTrip.positions.push(coords);
                    appState.currentTrip.polyline.push([coords.lat, coords.lng]);

                    // Centrer la carte
                    appState.map.setView([coords.lat, coords.lng], 16);

                    // Ajouter le marqueur de départ
                    if (appState.markers.start) {
                        appState.map.removeLayer(appState.markers.start);
                    }
                    
                    const startIcon = L.divIcon({
                        html: '<div style="background: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-weight: 600; color: #333; font-size: 14px;">A</div>',
                        iconSize: [32, 32],
                        className: ''
                    });
                    
                    appState.markers.start = L.marker([coords.lat, coords.lng], { icon: startIcon }).addTo(appState.map);

                    // Marqueur de position actuelle
                    const currentIcon = L.divIcon({
                        html: '<div style="background: #007AFF; border-radius: 50%; width: 16px; height: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [16, 16],
                        className: ''
                    });
                    
                    appState.markers.current = L.marker([coords.lat, coords.lng], { icon: currentIcon }).addTo(appState.map);

                    // Initialiser le tracé
                    appState.markers.path = L.polyline([], { color: '#007AFF', weight: 4, opacity: 0.8 }).addTo(appState.map);

                    // Obtenir l'adresse
                    const address = await getAddressFromCoords(coords.lat, coords.lng);
                    appState.currentTrip.startAddress = address;
                    
                    // Afficher l'adresse
                    const addressParts = address.split(',');
                    document.getElementById('startLocationName').textContent = addressParts[0] || 'Point de départ';
                    document.getElementById('startLocationAddress').textContent = addressParts.slice(1).join(',').trim() || coords.lat.toFixed(4) + ', ' + coords.lng.toFixed(4);
                },
                error => {
                    console.error('Erreur GPS:', error);
                    alert('Impossible d\'obtenir votre position. Vérifiez les permissions GPS.');
                },
                options
            );

            // Suivre la position
            appState.watchId = navigator.geolocation.watchPosition(
                position => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        timestamp: position.timestamp
                    };
                    
                    appState.currentTrip.positions.push(coords);
                    appState.currentTrip.polyline.push([coords.lat, coords.lng]);
                    
                    // Calculer la distance
                    if (appState.currentTrip.positions.length > 1) {
                        const lastPos = appState.currentTrip.positions[appState.currentTrip.positions.length - 2];
                        const distance = calculateDistance(lastPos.lat, lastPos.lng, coords.lat, coords.lng);
                        appState.currentTrip.distance += distance;
                        
                        // Mettre à jour l'affichage
                        document.getElementById('liveDistance').textContent = appState.currentTrip.distance.toFixed(1);
                        document.getElementById('liveAmount').textContent = (appState.currentTrip.distance * appState.settings.ratePerKm).toFixed(0);
                    }

                    // Mettre à jour la carte
                    if (appState.markers.current) {
                        appState.markers.current.setLatLng([coords.lat, coords.lng]);
                    }
                    
                    if (appState.markers.path) {
                        appState.markers.path.setLatLngs(appState.currentTrip.polyline);
                    }

                    // Centrer la carte sur la position actuelle
                    appState.map.setView([coords.lat, coords.lng], appState.map.getZoom());
                },
                error => console.error('Erreur GPS:', error),
                options
            );
        }

        // Arrêter le suivi
        async function stopTracking() {
            if (appState.watchId) {
                navigator.geolocation.clearWatch(appState.watchId);
            }

            // Récupérer les valeurs des champs
            appState.currentTrip.tags = document.getElementById('trackingTags').value;
            appState.currentTrip.note = document.getElementById('trackingNote').value;
            appState.currentTrip.reason = appState.currentTrip.note; // La note devient la raison

            // Obtenir la position finale
            navigator.geolocation.getCurrentPosition(async position => {
                appState.currentTrip.endLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    timestamp: position.timestamp
                };

                // Obtenir l'adresse d'arrivée
                const endAddress = await getAddressFromCoords(
                    appState.currentTrip.endLocation.lat,
                    appState.currentTrip.endLocation.lng
                );
                appState.currentTrip.endAddress = endAddress;

                // Sauvegarder le trajet
                const trip = {
                    ...appState.currentTrip,
                    endTime: new Date(),
                    id: Date.now()
                };

                appState.trips.push(trip);
                saveData();

                // Réinitialiser
                appState.isTracking = false;
                appState.currentTrip = null;
                
                // Nettoyer la carte
                if (appState.markers.start) appState.map.removeLayer(appState.markers.start);
                if (appState.markers.current) appState.map.removeLayer(appState.markers.current);
                if (appState.markers.path) appState.map.removeLayer(appState.markers.path);
                
                appState.markers.start = null;
                appState.markers.current = null;
                appState.markers.path = null;

                // Revenir à la vue normale
                document.getElementById('mapView').classList.remove('active');
                document.getElementById('normalView').classList.remove('hidden');
                
                // Mettre à jour l'affichage
                updateRecentTrips();
                
                // Si aucune note n'a été entrée, proposer d'en ajouter une
                if (!trip.note) {
                    setTimeout(() => {
                        if (confirm('Voulez-vous ajouter une note pour ce trajet?')) {
                            editTripNote(trip.id);
                        }
                    }, 500);
                } else {
                    // Message de confirmation
                    alert(`✅ Trajet enregistré!\n\n📏 Distance: ${trip.distance.toFixed(2)} km\n💰 Montant: ${(trip.distance * appState.settings.ratePerKm).toFixed(2)} $`);
                }
            });
        }

        // Géocoding inverse pour obtenir l'adresse
        async function getAddressFromCoords(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data.display_name) {
                    const parts = data.display_name.split(',');
                    return parts.slice(0, 3).join(',').trim();
                }
                return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            } catch (error) {
                console.error('Erreur géocodage:', error);
                return `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        // Calculer la distance entre deux points GPS
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Mettre à jour la liste déroulante des véhicules
        function updateVehicleSelect() {
            const select = document.getElementById('vehicleSelect');
            const currentValue = select.value;
            select.innerHTML = '<option value="">Sélectionner un véhicule</option>';
            
            appState.vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.name} (${vehicle.plate})`;
                select.appendChild(option);
            });

            if (currentValue) {
                select.value = currentValue;
            } else if (appState.settings.defaultVehicle) {
                select.value = appState.settings.defaultVehicle;
            }
        }

        // Afficher les trajets récents
        function updateRecentTrips() {
            const list = document.getElementById('recentTripsList');
            
            // Prendre les 5 derniers trajets
            const recentTrips = appState.trips.slice(-5).reverse();
            
            if (recentTrips.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Aucun trajet enregistré</div>';
                return;
            }
            
            list.innerHTML = recentTrips.map(trip => {
                const vehicle = appState.vehicles.find(v => v.id == trip.vehicleId);
                const date = new Date(trip.startTime);
                const dateStr = `${date.getDate()}/${(date.getMonth() + 1).toString().padStart(2, '0')} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                const desc = trip.note || trip.reason || 'Sans description';
                
                return `
                    <div class="trip-item" onclick="editTripNote(${trip.id})">
                        <div class="trip-info">
                            <div class="trip-date">${dateStr}</div>
                            <div class="trip-desc">${desc.substring(0, 50)}${desc.length > 50 ? '...' : ''}</div>
                        </div>
                        <div class="trip-distance">${trip.distance.toFixed(1)} km</div>
                    </div>
                `;
            }).join('');
        }

        // Éditer la note d'un trajet
        function editTripNote(tripId) {
            const trip = appState.trips.find(t => t.id === tripId);
            if (!trip) return;

            appState.editingTripId = tripId;
            appState.modalAction = 'editNote';

            document.getElementById('modalTitle').textContent = 'Modifier le trajet';
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">Note / Raison du déplacement</label>
                    <textarea id="editNote" class="note-field" style="width: 100%; min-height: 100px;" placeholder="Ex: Visite client ABC Corp, Achat matériel Home Depot...">${trip.note || trip.reason || ''}</textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">Étiquettes</label>
                    <input type="text" id="editTags" class="input-field" style="width: 100%;" placeholder="Ex: client, urgent, projet-x" value="${trip.tags || ''}">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">Catégorie</label>
                    <div class="category-buttons">
                        <button class="category-btn ${trip.category !== 'professional' ? 'active' : ''}" onclick="document.getElementById('editCategory').value='personal'; this.classList.add('active'); this.nextElementSibling.classList.remove('active');">
                            🏠 Personnel
                        </button>
                        <button class="category-btn ${trip.category === 'professional' ? 'active' : ''}" onclick="document.getElementById('editCategory').value='professional'; this.classList.add('active'); this.previousElementSibling.classList.remove('active');">
                            💼 Professionnel
                        </button>
                    </div>
                    <input type="hidden" id="editCategory" value="${trip.category || 'professional'}">
                </div>
            `;

            document.getElementById('editModal').classList.add('active');
        }

        // Fermer le modal
        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            appState.editingTripId = null;
            appState.modalAction = null;
        }

        // Sauvegarder les modifications du modal
        function saveModal() {
            if (appState.modalAction === 'editNote' && appState.editingTripId) {
                const trip = appState.trips.find(t => t.id === appState.editingTripId);
                if (trip) {
                    trip.note = document.getElementById('editNote').value;
                    trip.reason = trip.note;
                    trip.tags = document.getElementById('editTags').value;
                    trip.category = document.getElementById('editCategory').value;
                    saveData();
                    updateRecentTrips();
                }
            } else if (appState.modalAction === 'addVehicle') {
                const name = document.getElementById('newVehicleName').value.trim();
                const plate = document.getElementById('newVehiclePlate').value.trim();
                const km = document.getElementById('newVehicleKm').value;
                
                if (name && plate && km) {
                    const vehicle = {
                        id: Date.now(),
                        name: name,
                        plate: plate,
                        km: parseInt(km)
                    };
                    
                    appState.vehicles.push(vehicle);
                    saveData();
                    updateVehicleSelect();
                }
            } else if (appState.modalAction === 'settings') {
                appState.settings.ratePerKm = parseFloat(document.getElementById('settingsRate').value) || 0.70;
                appState.settings.companyName = document.getElementById('settingsCompany').value;
                appState.settings.defaultVehicle = document.getElementById('settingsDefaultVehicle').value;
                saveData();
                updateVehicleSelect();
            }

            closeModal();
        }

        // Afficher la gestion des véhicules
        function showVehicles() {
            appState.modalAction = 'addVehicle';
            
            document.getElementById('modalTitle').textContent = 'Gérer les véhicules';
            
            let vehiclesList = '';
            if (appState.vehicles.length > 0) {
                vehiclesList = '<div style="margin-bottom: 20px;"><h4 style="margin-bottom: 10px;">Mes véhicules</h4>';
                vehiclesList += appState.vehicles.map(v => `
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${v.name}</strong><br>
                            <small style="color: #666;">Plaque: ${v.plate} | Km: ${v.km}</small>
                        </div>
                        <button onclick="deleteVehicle(${v.id})" style="background: #ff3b30; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">Supprimer</button>
                    </div>
                `).join('');
                vehiclesList += '</div>';
            }
            
            document.getElementById('modalBody').innerHTML = vehiclesList + `
                <h4 style="margin-bottom: 10px;">Ajouter un véhicule</h4>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="newVehicleName" class="input-field" style="width: 100%;" placeholder="Marque et modèle (ex: Toyota Camry)">
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="newVehiclePlate" class="input-field" style="width: 100%;" placeholder="Plaque d'immatriculation">
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="number" id="newVehicleKm" class="input-field" style="width: 100%;" placeholder="Kilométrage actuel">
                </div>
            `;
            
            document.getElementById('editModal').classList.add('active');
        }

        // Supprimer un véhicule
        function deleteVehicle(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce véhicule?')) {
                appState.vehicles = appState.vehicles.filter(v => v.id !== id);
                saveData();
                updateVehicleSelect();
                showVehicles(); // Rafraîchir le modal
            }
        }

        // Afficher l'historique complet
        function showHistory() {
            window.location.href = '#history';
            // Pour une vraie app, créer une nouvelle vue avec l'historique complet
            alert('Historique complet - Fonctionnalité à venir\n\nPour l\'instant, vous pouvez voir les 5 derniers trajets sur l\'écran principal.');
        }

        // Afficher les paramètres
        function showSettings() {
            appState.modalAction = 'settings';
            
            document.getElementById('modalTitle').textContent = 'Paramètres';
            
            let vehicleOptions = '<option value="">Aucun</option>';
            vehicleOptions += appState.vehicles.map(v => 
                `<option value="${v.id}" ${appState.settings.defaultVehicle == v.id ? 'selected' : ''}>${v.name}</option>`
            ).join('');
            
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">Taux de remboursement ($/km)</label>
                    <input type="number" id="settingsRate" class="input-field" style="width: 100%;" step="0.01" value="${appState.settings.ratePerKm}">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">Nom de l'entreprise</label>
                    <input type="text" id="settingsCompany" class="input-field" style="width: 100%;" placeholder="Ex: ABC Construction Inc." value="${appState.settings.companyName || ''}">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">Véhicule par défaut</label>
                    <select id="settingsDefaultVehicle" class="vehicle-select" style="width: 100%;">
                        ${vehicleOptions}
                    </select>
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="exportCSV()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px;">
                        📥 Exporter le rapport mensuel
                    </button>
                </div>
            `;
            
            document.getElementById('editModal').classList.add('active');
        }

        // Exporter en CSV
        function exportCSV() {
            const now = new Date();
            const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                               'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyTrips = appState.trips.filter(trip => {
                const tripDate = new Date(trip.startTime);
                return tripDate.getMonth() === currentMonth && tripDate.getFullYear() === currentYear;
            });
            
            if (monthlyTrips.length === 0) {
                alert('Aucun trajet à exporter ce mois-ci');
                return;
            }
            
            let csv = 'Date,Heure,Véhicule,Distance (km),Montant ($),Catégorie,Raison/Note,Départ,Arrivée,Étiquettes\n';
            
            monthlyTrips.forEach(trip => {
                const vehicle = appState.vehicles.find(v => v.id == trip.vehicleId);
                const date = new Date(trip.startTime);
                const dateStr = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                const time = `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                const amount = trip.distance * appState.settings.ratePerKm;
                const category = trip.category === 'professional' ? 'Professionnel' : 'Personnel';
                const reason = (trip.note || trip.reason || 'Non spécifié').replace(/"/g, '""');
                const tags = (trip.tags || '').replace(/"/g, '""');
                
                csv += `${dateStr},${time},"${vehicle ? vehicle.name : 'N/A'}",${trip.distance.toFixed(2)},${amount.toFixed(2)},${category},"${reason}","${trip.startAddress || 'N/A'}","${trip.endAddress || 'N/A'}","${tags}"\n`;
            });
            
            // Ajouter le résumé
            const totalKm = monthlyTrips.reduce((sum, trip) => sum + trip.distance, 0);
            const totalAmount = totalKm * appState.settings.ratePerKm;
            const proTrips = monthlyTrips.filter(t => t.category === 'professional');
            const proKm = proTrips.reduce((sum, trip) => sum + trip.distance, 0);
            const proAmount = proKm * appState.settings.ratePerKm;
            
            csv += `\nRÉSUMÉ ${monthNames[currentMonth]} ${currentYear}\n`;
            if (appState.settings.companyName) {
                csv += `Entreprise:,"${appState.settings.companyName}"\n`;
            }
            csv += `\nTOTAL GÉNÉRAL\n`;
            csv += `Distance totale:,${totalKm.toFixed(2)} km\n`;
            csv += `Montant total:,${totalAmount.toFixed(2)} $\n`;
            csv += `Nombre de trajets:,${monthlyTrips.length}\n`;
            csv += `\nTRAJETS PROFESSIONNELS\n`;
            csv += `Distance:,${proKm.toFixed(2)} km\n`;
            csv += `Montant:,${proAmount.toFixed(2)} $\n`;
            csv += `Nombre:,${proTrips.length}\n`;
            csv += `\nTaux appliqué:,${appState.settings.ratePerKm} $/km\n`;
            
            // Télécharger le fichier
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `logbook_${monthNames[currentMonth]}_${currentYear}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Rapport exporté!\nFichier: logbook_${monthNames[currentMonth]}_${currentYear}.csv`);
        }

        // Données de test
        function addTestData() {
            if (appState.vehicles.length === 0) {
                appState.vehicles = [
                    { id: 1, name: 'Ford F-150', plate: '308 VEQ', km: 45000 },
                    { id: 2, name: 'Honda Civic', plate: 'ABC 123', km: 32000 }
                ];
                appState.settings.defaultVehicle = 1;
            }
            
            const now = new Date();
            appState.trips.push({
                id: Date.now() - 1000000,
                vehicleId: 1,
                category: 'professional',
                note: 'Visite client ABC Corp - Présentation nouveau produit',
                tags: 'client, important',
                startTime: new Date(now.getTime() - 86400000 * 2),
                endTime: new Date(now.getTime() - 86400000 * 2 + 3600000),
                distance: 45.3,
                startAddress: '24 Rue Robert-Savoie, Gatineau',
                endAddress: '123 Boulevard Saint-Laurent, Montréal'
            });
            
            saveData();
            updateVehicleSelect();
            updateRecentTrips();
        }

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Proposer des données de test si première utilisation
            if (appState.vehicles.length === 0 && appState.trips.length === 0) {
                if (confirm('Première utilisation détectée.\nVoulez-vous charger des données de démonstration?')) {
                    addTestData();
                }
            }
        });

        // Prévenir la fermeture accidentelle
        window.addEventListener('beforeunload', function(e) {
            if (appState.isTracking) {
                e.preventDefault();
                e.returnValue = 'Un trajet est en cours. Êtes-vous sûr de vouloir quitter?';
            }
        });
    </script>
</body>
</html>
